---
title: "Make data files"
output: 
  github_document:
    toc: true
editor_options: 
  chunk_output_type: console
---

---

```{r setup, include=FALSE}
library(dplyr)
library(tidyr)
library(stringi)
library(lubridate)
library(intervals)
library(igraph)
requireNamespace("here")

knitr::opts_chunk$set(
  echo = TRUE,
  cache = FALSE
)
```

Processing the files from `data-src` to produce data frames and igraph/network objects for analysis.




# Trades data

Load trades data from Zachary Richardson. Group trades into seasons using April 1 of each year.

```{r}
e <- new.env()
load(here::here("data-src", "data", "NBA_AnalysisData.RData"), envir=e)

trades <- e$trade.df_long |>
  select(-season) |> # This one is wrong
  mutate(
    season_from = case_when(
      month(Date) >= 4 ~ as.numeric(year(Date)),
      month(Date) <= 3 ~ as.numeric(year(Date)) - 1,
      TRUE ~ as.numeric(NA)
    ),
    season_to = season_from + 1,
    season = paste0(season_from, "-", season_to)
  )
```


# Seasonal networks

Create a list of igraph objects with edge attribute `weight` counting the trades:

```{r graphlist}
graphlist <- lapply(
  sort(unique(trades$season)),
  function(s) {
    g <- graph_from_data_frame( 
      edb %>%
        filter(season == s) %>%
        select(P1, P2), 
      directed=FALSE)
    E(g)$weight <- count_multiple(g)
    g <- simplify(g)
    g$season <- s
    g
  }
)
```

Since that was built from edges, non-trading teams are inadvertently excluded. Here, we're adding them back in.

```{r graphlist-add-nodes}
graphlist[[3]] <- add.vertices(graphlist[[3]], 1, name="Spurs", label="Spurs", div="Central")

graphlist[[4]] <- add.vertices(graphlist[[4]], 1, name="Celtics", label="Celtics", div="Atlantic")
graphlist[[4]] <- add.vertices(graphlist[[4]], 1, name="Warriors", label="Warriors", div="Pacific")

graphlist[[5]] <- add.vertices(graphlist[[5]], 1, name="76ers", label="76ers", div="Atlantic")

graphlist[[9]] <- add.vertices(graphlist[[9]], 1, name="Nets", label="Nets", div="Atlantic")
graphlist[[9]] <- add.vertices(graphlist[[9]], 1, name="Suns", label="Suns", div="Pacific")

graphlist[[10]] <- add.vertices(graphlist[[10]], 1, name="Nuggets", label="Nuggets", div="Midwest")
graphlist[[10]] <- add.vertices(graphlist[[10]], 1, name="Knicks", label="Knicks", div="Atlantic")

graphlist[[11]] <- add.vertices(graphlist[[11]], 1, name="Suns", label="Suns", div="Pacific")
graphlist[[11]] <- add.vertices(graphlist[[11]], 1, name="Warriors", label="Warriors", div="Pacific")

graphlist[[12]] <- add.vertices(graphlist[[12]], 1, name="Mavericks", label="Mavericks", div="Midwest")

graphlist[[14]] <- add.vertices(graphlist[[14]], 1, name="Lakers", label="Lakers", div="Pacific")
graphlist[[14]] <- add.vertices(graphlist[[14]], 1, name="Wizards", label="Bullets", div="Atlantic")
graphlist[[14]] <- add.vertices(graphlist[[14]], 1, name="Jazz", label="Jazz", div="Midwest")

graphlist[[15]] <- add.vertices(graphlist[[15]], 1, name="Pacers", label="Pacers", div="Central")
graphlist[[15]] <- add.vertices(graphlist[[15]], 1, name="Celtics", label="Celtics", div="Atlantic")
graphlist[[15]] <- add.vertices(graphlist[[15]], 1, name="Knicks", label="Knicks", div="Atlantic")
graphlist[[15]] <- add.vertices(graphlist[[15]], 1, name="Cavaliers", label="Cavaliers", div="Central")

graphlist[[16]] <- add.vertices(graphlist[[16]], 1, name="76ers", label="76ers", div="Atlantic")
graphlist[[16]] <- add.vertices(graphlist[[16]], 1, name="Pacers", label="Pacers", div="Central")
graphlist[[16]] <- add.vertices(graphlist[[16]], 1, name="Nets", label="Nets", div="Atlantic")
graphlist[[16]] <- add.vertices(graphlist[[16]], 1, name="Magic", label="Magic", div="Atlantic")

graphlist[[18]] <- add.vertices(graphlist[[18]], 1, name="Heat", label="Heat", div="Atlantic")
graphlist[[18]] <- add.vertices(graphlist[[18]], 1, name="Celtics", label="Celtics", div="Atlantic")

graphlist[[19]] <- add.vertices(graphlist[[19]], 1, name="Kings", label="Kings", div="Pacific")
graphlist[[19]] <- add.vertices(graphlist[[19]], 1, name="Nets", label="Nets", div="Atlantic")
graphlist[[19]] <- add.vertices(graphlist[[19]], 1, name="Bulls", label="Bulls", div="Central")
graphlist[[19]] <- add.vertices(graphlist[[19]], 1, name="Cavaliers", label="Cavaliers", div="Central")

graphlist[[20]] <- add.vertices(graphlist[[20]], 1, name="Pacers", label="Pacers", div="Central")
graphlist[[20]] <- add.vertices(graphlist[[20]], 1, name="Rockets", label="Rockets", div="Midwest")
graphlist[[20]] <- add.vertices(graphlist[[20]], 1, name="Jazz", label="Jazz", div="Midwest")
graphlist[[20]] <- add.vertices(graphlist[[20]], 1, name="Mavericks", label="Mavericks", div="Midwest")

graphlist[[21]] <- add.vertices(graphlist[[21]], 1, name="76ers", label="76ers", div="Atlantic")
graphlist[[21]] <- add.vertices(graphlist[[21]], 1, name="Bulls", label="Bulls", div="Central")
graphlist[[21]] <- add.vertices(graphlist[[21]], 1, name="Cavaliers", label="Cavaliers", div="Central")
graphlist[[21]] <- add.vertices(graphlist[[21]], 1, name="Spurs", label="Spurs", div="Midwest")
graphlist[[21]] <- add.vertices(graphlist[[21]], 1, name="Clippers", label="Clippers", div="Pacific")

graphlist[[22]] <- add.vertices(graphlist[[22]], 1, name="Lakers", label="Lakers", div="Pacific")
graphlist[[22]] <- add.vertices(graphlist[[22]], 1, name="Jazz", label="Jazz", div="Midwest")
graphlist[[22]] <- add.vertices(graphlist[[22]], 1, name="Wizards", label="Wizards", div="Atlantic")
graphlist[[22]] <- add.vertices(graphlist[[22]], 1, name="Spurs", label="Spurs", div="Midwest")

graphlist[[23]] <- add.vertices(graphlist[[23]], 1, name="Heat", label="Heat", div="Atlantic")
graphlist[[23]] <- add.vertices(graphlist[[23]], 1, name="Pacers", label="Pacers", div="Central")
graphlist[[23]] <- add.vertices(graphlist[[23]], 1, name="Clippers", label="Clippers", div="Pacific")

graphlist[[24]] <- add.vertices(graphlist[[24]], 1, name="Heat", label="Heat", div="Atlantic")
graphlist[[24]] <- add.vertices(graphlist[[24]], 1, name="Jazz", label="Jazz", div="Midwest")
graphlist[[24]] <- add.vertices(graphlist[[24]], 1, name="Knicks", label="Knicks", div="Atlantic")

graphlist[[25]] <- add.vertices(graphlist[[25]], 1, name="Timberwolves", label="Timberwolves", div="Midwest")
graphlist[[25]] <- add.vertices(graphlist[[25]], 1, name="Nets", label="Nets", div="Atlantic")

graphlist[[26]] <- add.vertices(graphlist[[26]], 1, name="Jazz", label="Jazz", div="Midwest")

graphlist[[27]] <- add.vertices(graphlist[[27]], 1, name="Heat", label="Heat", div="Atlantic")
graphlist[[27]] <- add.vertices(graphlist[[27]], 1, name="Pacers", label="Pacers", div="Central")
graphlist[[27]] <- add.vertices(graphlist[[27]], 1, name="Timberwolves", label="Timberwolves", div="Midwest")
graphlist[[27]] <- add.vertices(graphlist[[27]], 1, name="Mavericks", label="Mavericks", div="Midwest")

graphlist[[28]] <- add.vertices(graphlist[[28]], 1, name="Heat", label="Heat", div="Atlantic")
graphlist[[28]] <- add.vertices(graphlist[[28]], 1, name="Lakers", label="Lakers", div="Pacific")

graphlist[[29]] <- add.vertices(graphlist[[29]], 1, name="Timberwolves", label="Timberwolves", div="Northwest")

graphlist[[30]] <- add.vertices(graphlist[[30]], 1, name="Mavericks", label="Mavericks", div="Southwest")
graphlist[[30]] <- add.vertices(graphlist[[30]], 1, name="Spurs", label="Spurs", div="Southwest")
graphlist[[30]] <- add.vertices(graphlist[[30]], 1, name="Warriors", label="Warriors", div="Pacific")

graphlist[[31]] <- add.vertices(graphlist[[31]], 1, name="Heat", label="Heat", div="Southeast")
graphlist[[31]] <- add.vertices(graphlist[[31]], 1, name="Clippers", label="Clippers", div="Pacific")
graphlist[[31]] <- add.vertices(graphlist[[31]], 1, name="Kings", label="Kings", div="Pacific")
graphlist[[31]] <- add.vertices(graphlist[[31]], 1, name="Wizards", label="Wizards", div="Southeast")
graphlist[[31]] <- add.vertices(graphlist[[31]], 1, name="Knicks", label="Knicks", div="Atlantic")

graphlist[[32]] <- add.vertices(graphlist[[32]], 1, name="Bucks", label="Bucks", div="Central")

graphlist[[33]] <- add.vertices(graphlist[[33]], 1, name="Hawks", label="Hawks", div="Southeast")

graphlist[[34]] <- add.vertices(graphlist[[34]], 1, name="Pacers", label="Pacers", div="Central")

graphlist[[35]] <- add.vertices(graphlist[[35]], 1, name="Pistons", label="Pistons", div="Central")

graphlist[[36]] <- add.vertices(graphlist[[36]], 1, name="Pistons", label="Pistons", div="Central")
graphlist[[36]] <- add.vertices(graphlist[[36]], 1, name="Suns", label="Suns", div="Pacific")

graphlist[[37]] <- add.vertices(graphlist[[37]], 1, name="Spurs", label="Spurs", div="Southwest")

graphlist[[38]] <- add.vertices(graphlist[[38]], 1, name="Magic", label="Magic", div="Southeast")

graphlist[[39]] <- add.vertices(graphlist[[39]], 1, name="Warriors", label="Warriors", div="Pacific")

graphlist[[41]] <- add.vertices(graphlist[[41]], 1, name="Timberwolves", label="Timberwolves", div="Northwest")

graphlist[[42]] <- add.vertices(graphlist[[42]], 1, name="Spurs", label="Spurs", div="Southwest")

graphlist[[43]] <- add.vertices(graphlist[[43]], 1, name="Warriors", label="Warriors", div="Pacific")

graphlist[[44]] <- add.vertices(graphlist[[44]], 1, name="Raptors", label="Raptors", div="Atlantic")
```

Save

```{r graphlist-save}
saveRDS(graphlist, file = "wgl.rds")
```




# Edge and node data frames



## Vertex database

A data frame for `season` x `name` with:

- `name` -- time-constant "franchise name"
- `label` -- time-varying team name
- `div` -- division name
- `season`, `season_from`, `season_to` -- season dates

```{r vdb}
vdb <- graphlist %>%
  setNames(nm = vapply(graphlist, graph_attr, character(1), name = "season")) %>%
  lapply(igraph::as_data_frame, what = "vertices") %>%
  bind_rows(.id = "season") %>%
  as_tibble() %>%
  separate(season, into = c("season_from", "season_to"), remove = FALSE) %>%
  mutate(
    across(starts_with("season_"), as.integer)
  )
vdb
```




## Edge database

A data frame for `season` x `from` x `to` where `from < to` with:

- `from`, `to` -- franchise names
- `season`, `season_from`, `season_to` -- season dates
- `weight` -- number of trades between `from` and `to` in `season`

```{r edb}
edb <- graphlist %>%
  setNames(nm = vapply(graphlist, graph_attr, character(1), name = "season")) %>%
  lapply(igraph::as_data_frame, what = "edges") %>%
  bind_rows(.id = "season") %>%
  as_tibble() %>%
  separate(season, into = c("season_from", "season_to"), remove = FALSE) %>%
  mutate(
    across(starts_with("season_"), as.integer),
    .from = pmin(from, to),
    .to = pmax(from, to)
  ) %>%
  select(
    from = .from, 
    to = .to, 
    season, 
    season_from,
    season_to,
    weight
  )
edb
```





## Checks 

Team names in `vdb` and `edb` match:

```{r check}
u_vdb_teams <- with(vdb, unique(name))
u_edb_teams <- with(edb, unique(c(from, to)))
stopifnot(all(u_vdb_teams %in% u_edb_teams))
stopifnot(all(u_edb_teams %in% u_vdb_teams))
```


## Save

```{r save}
saveRDS(vdb, file = here::here("data", "df-vdb.rds"))
saveRDS(edb, file = here::here("data", "df-edb.rds"))
```













<!-- Include folded session info -->
<details>
<summary>Session info</summary>
```{r session-info}
sessioninfo::session_info()
```
</details>
